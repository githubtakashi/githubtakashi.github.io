# Visual Studio 2005を習得するためのメモ

メルカリで入手したvisual studio 2005 standard editionを使って勉強していく際のメモを

書いていきます。

なぜ2021年にvisual studio 2005を使うかというと、c++を使ったアプリを作れるようになりたい

のもそうだけど、古いthinkpad使いたいのが一番の目的かも。

古いthinkpadを使いたいけどネット接続はOSが古いので危険なので、ネットにつながない。

となると、文書作成したりコマンドプロンプトやバッチファイルの書き方を勉強するくらいしか使い道が

なさげ。

visual studioを使うことで古いthinkpadを活用でき、使い道の限られた古いwindowsを有意義に使える。

visual studio 2005はwindows2000～xpまでのOSで使えるらしいので、

windows xpのthinkpad T42にvisual studio 2005をインストールしました。

<br />

## visual studio 2005を使って勉強進める際の問題点

問題点は、2000年代前半のvisual studioなのでvisual studio2005の情報がネット上に

ほとんど存在しないこと。

僕が検索した限り16年くらい前はがっつりvisual studioの使い方など実用的な記事を作っていた人は少ないみたい。

最近の情報ならあるけど互換性の問題も大きいです。

書き方が今と違ったりするので新しいバージョンのvisual studioの情報では分からないことがあったときに躓く可能性があります。

<br />

## MSDNライブラリを活用する

cd-romからインストールしたMSDNライブラリに充実した内容のコンテンツがいっぱいあるので、

MSDNライブラリを活用するのが一番よさそうです。

チュートリアルが多くあるので、まずはチュートリアルを進めて作りつつ勉強していく方針で進めます。

<br />

## 用語など

チュートリアルを進めていくときにメモをとっていく。

### DLL

Dynamic Link Library(動的リンクライブラリ)

DLLとは、Windowsのプログラムファイルの種類のひとつ。いろいろなプログラムから利用される汎用性の高い機能が収録された、

部品化されたプログラム。拡張子は.dll

動的リンクライブラリという名前のとおり、実行時に必要なファイルを動的にリンクする。

動的リンクは実行ファイルから参照されるライブラリなどを実行時に連結する。

実行環境側でライブラリを用意する必要があるが実行ファイル本体を軽量にでき、

本体のみやライブラリのみなどといった、依存性が低いので部分的な修正や更新がやりやすい。

静的リンクの場合は、リンカは参照される関数全部をstatic link libraryから取得して実行コード内に配置

する。一方、dllの動的リンクは実行時での必要な情報だけ含めることが可能なので、メモリの節約など利点が多い。

<br />

### スタティックライブラリ

dllはプログラムの実行時に合体させるライブラリとは対照的に、

スタティックライブラリはプログラムを作成するときにプログラムと合体させるライブラリのこと。

<br />

### ビルドしたときにメッセージで出てくるマニフェストとは

ビルドしたアプリケーションのランタイム依存について書かれたドキュメントをマニフェストという.

外部ファイルか、ニーモックで書かれたアセンブリか、アプリ内に埋め込まれる。

<br />

### シンボルとは

プログラムデータベースファイル(.pdb)のことをシンボルファイルと呼ぶ。

プログラムデータベースファイルとは、デバッグ時に作成されるファイルのことで、

ソースコードをコンパイル時にソースコードからpdbファイルが作られる。

pdbファイルには、プログラムに関するデバッグ情報とプログラムの状態が保持されている。

<br />

## windows フォームコントロール

windowsのwindowの枠内に表示、機能させることができるアプリケーション

windowsフォームアプリケーション(共通言語ランタイムを対象にするGUIアプリケーション)に配置されるコンポーネントのことを

フォームコントロールという。

<br />

### CLRとは

Common Language Runtime(共通言語ランタイム)の略で、.net applicationを実行するためのバーチャルマシンのこと。

.net applicationとは、マイクロソフトが開発したアプリ開発や実行環境のこと。

CLRがマネージドコードの取得とコンパイルと実行を行う。

マネージドコードとは、実行がCLRによって管理されているコードのこと。

<br />

### マネージアセンブリとは

マネージドコードで部品化したプログラムを作成し、部品化(モジュール化)することで、他で参照して使う。

作成するプログラムごとにいちいち部品を実装するのではなく、マネージアセンブリを作っておくと他のアプリケーションから

マネージアセンブリを機能として参照して使える。

CLR(共通言語ランタイム)の環境を前提とした部品プログラムをマネージアセンブリと呼ぶ。

<br />

### プリコンパイル済みヘッダーファイルとは

ヘッダーファイルまたはヘッダーファイルに含まれるファイルの内容が変更された場合のみ

コンパイルされる機能のこと。

コンパイル時間を短くしてくれるのでビルド時間が短くなる。

すでにコンパイルが通っていて変更がなく安定しているコードについては解析の対象から除外

することで、コンパイル時間が短縮される。

<br />

### ref修飾子とは

参照渡しにできる修飾子

```
public ref class MyMathFuncs {//method...}
```

<br />

### gcnewとは

CLR環境で使う。参照渡し、値渡しのデータに対してマネージド型のメモリが割り当てられ、

ガベージコレクションによって自動的にメモリが解放される。

```
if (b == 0)
{
  thwow gcnew DivideByZeroException("b cannot be Zero!");
}
```

<br />

***

## COMとは

component object modelとは、マイクロソフトによる、ソフトウェアの機能を部品化して外部から呼び出して利用する仕組みのこと。

OSやプログラミング言語に依存しないので、様々な言語やOSで開発されたプログラムを連携できる。

部品化された（単体では動作しない）ソフトウェアをCOMコンポーネントと呼ぶ。

アプリケーションに組み込むことで、その機能を呼び出し、利用できる。

<br />

### COMサーバーとは

アプリケーションソフトウェアはCOMインターフェースを介してCOMコンポーネントと

通信を行う。COMコンポーネントを提供するものがCOMサーバー。

ググっても説明が見当たらないのでこんな感じのイメージ。

<br />

### ATL(Active Template Library)とは

COM開発を簡単にするためのラッパーライブラリ。

<br /> 

### MFC(Microsoft Foundation Classes)とは

Visual C++でのWindows用のアプリ構築するときに利用するクラスライブラリ。

ATLと一緒にVisual Studioに同梱されるライブラリ。

一般的にアプリでよく使われるクラスが準備されている。

<br />

### regsvr32

windowsのコマンドで、Microsoft Register Serverの略。

dllファイルやOLE（Object Linking and Embedding）コントロールの登録や解除の時に使うコマンド。

regsvr32コマンドでDLLファイルを登録したらdllファイルについての情報がWindowsレジストリに追加される。

これによって、他のプログラムからレジストリ内でアクセスされ参照されるようになる。

例)サーバーオブジェクトであるTestServer.cppをdllオプションでコンパイルしサーバー(windowsレジストリ)に登録

```
> cl /LD TestServer.cpp
> regsvr32 TestServer.dll
```

<br />

### HRESULT型

HRESULT型はlong型の数値で、COMインターフェース関係の関数返り値に使われることが多い型。

BOOL型と似てるけど、大きな違いはBOOL型は返り値としてtrueかfalseしかないのに対し、

HRESULT型は0x00000000～0xFFFFFFFFまでの多くの値がつかえる。

BOOL型ではfalseの原因を取得したいときはGetLastError()を使う必要があったけど、HRESULT型だと値を見るだけで

falseの原因まで分かるようになっている。

***

<br />

### IDispatch

COMでイベント処理を行うときに使うインターフェース。

他のいろんなCOMインターフェースを呼び出すことができる。

COMサーバーの実装ファイルの中で宣言する。

<br />

### coclass

comではクラスのことをcoclassと呼ぶ。

<br />

### threading

threadクラスはスレッドを作成して制御する。優先順位の設定やステータスの取得を行う。

COMではthreadがdeadlockやrace conditionsにならないように制御してくれる機能を提供している。

race conditionsとは、並列動作するプロセスやスレッドが同じリソースにほぼ同時にアクセスしたときに

予定外の処理結果が起こってしまうこと。

プロセスにおけるCOMオブジェクトはApartmentと呼び、分けて考える。

SingleThreaded ApartmentとMultiThreaded Apartmentに分類される。

SingleThreaded ApartmentはSingleThreaded Apartmentのスレッドとの同期を

wondowsのメッセージキューを利用して同期する。

MultiThreaded Apartmentはwindowsのメッセージキューを使わずオブジェクト同士が

直接通信して同期を行う。

<br />

### インプロセスサーバーとアウトプロセスサーバー

インプロセスサーバーはdllファイルに実装されるサーバーのこと。  
アウトプロセスサーバーはexeファイルに実装されるサーバーのこと。  

<br />

### VTable

仮想関数の情報を持ったテーブルみたいなイメージ。  
ポインタでメソッドを使うときに、ポインタが参照する仮想関数が2種類以上とかあって、どれを使えば分からなくなるのを  
VTableを利用することで防ぎ、意図に沿った適切な仮想関数を参照してくれる仕組み。

<br />

### ストレージクラス

変数や定数のデータを格納したメモリ領域をオブジェクトと呼ぶ。  
オブジェクトが格納されたメモリ空間の種類をストレージクラスと呼ぶ。

オブジェクトはライフタイムとかデータのアクセス保護情報の違いで、異なる種類のメモリ空間に属している。  
同じメモリ空間に属す場合でも、初期値によってその初期化方法が異なる場合がある。  
それらのメモリ空間はそれぞれ異なるアクセス保護がされる。  
ストレージクラスとは、オブジェクトがそれらどのメモリ空間に属するかを指すためのもの。  

メモリ空間の種類は言語処理系に依存する。代表的なメモリ空間は下記。

- スタック領域  
言語処理系が必要に応じてメモリを確保したり解放したりするメモリ空間

- ヒープ領域  
プログラムを組む人が自由に確保したり解放の操作をしてよいメモリ空間

- データ領域  
言語処理系が使用する固定サイズのメモリ空間で、プログラムの開始時にメモリが確保され、終了時に解放される。

- テキスト領域  
命令列が格納されるメモリ空間。

## __declspec(dllexport)

dll作成の時にメソッド宣言に付ける。
dllをエクスポートして他のアプリケーションで使えるようにするために付加する修飾子。

<br />

## visual C++ /EHsc

/EHscはコンパイラに対して例外処理を有効化するためのオプション。

<br />

## visual c++ /LD

/LDオプションはDLLを作成するために必要なオプション。

visual studioのメニューでdllになるようにビルド設定してビルドすると自動的に/LDオプションでdllが作成される。

コマンドラインからビルドするときは/LDコンパイラオプションを使用し出力ファイルがdllになるようにする。

<br />

## clコマンドとは

clとはvisual C++のコンパイラのことで、visual c++に付属しているコマンドラインで

clコマンドを実行するとソースファイルを手動でコンパイルできる。

例)コンパイルする例

```
> cl /LD test.cpp
```

<br />


## <stdexcept>ヘッダーファイル

stdexceptヘッダをインクルードすると標準的な例外処理のクラスが使えるようになる。
  
```
#include <stdexcept>
using namespace std;
```
  
std名前空間で使えるのでusing namespace stdを宣言する必要がある。
  
<br />
  
## stdafx.hヘッダーファイルとは

プリコンパイル済みヘッダーファイルのこと。
visual c++のプロジェクトのcppファイルにデフォルトで書かれている。
  
<br />























